# Enabling HTTPS in Nuxt Development

This guide explains how to enable HTTPS for local development. HTTPS is required when connecting to StatusDB dev, which requires secure connections.

## Configure Nuxt for HTTPS

The Nuxt development server can be configured to use HTTPS by providing SSL/TLS certificates. We use [mkcert](https://github.com/FiloSottile/mkcert) to generate locally-trusted certificates, which allows browsers to accept the HTTPS connection without security warnings.

### Prerequisites

Install `mkcert`, a tool for making locally-trusted development certificates:

#### macOS

```bash
brew install mkcert
brew install nss   # Required for Firefox support
```

#### Linux

```bash
sudo apt install libnss3-tools
# Then install mkcert from your package manager or build from source
```

### HTTPS Certificate setup steps

#### 1. Create and Trust a Local CA

Install mkcert's root certificate authority on your system. This allows browsers to trust certificates generated by mkcert:

```bash
mkcert -install
```

This command:

- Creates a local certificate authority (CA)
- Installs it in your system's trust store
- Allows browsers to trust certificates signed by this CA

#### 2. Generate Certificates for Localhost

Generate SSL certificates for localhost and common local IP addresses:

```bash
mkcert localhost 127.0.0.1 ::1
```

This produces two files:

- `localhost.pem` - The certificate file
- `localhost-key.pem` - The private key file

#### 3. Move Certificates to a permanent Location

Create a directory to store your certificates and move them there:

```bash
mkdir -p ~/certs
mv localhost.pem localhost-key.pem ~/certs/
```

**Note:** You can use any directory you prefer. Just make sure to use absolute paths in the next step.

#### 4. Set File Permissions

Secure the private key file by restricting access:

```bash
chmod 600 ~/certs/localhost-key.pem
```

This ensures only you can read the private key, which is important for security.

#### 5. Configure Environment Variables

Add the certificate paths to your `.env` file using **absolute paths**:

```bash
LOCALHOST_HTTPS_KEY=/Users/yourusername/certs/localhost-key.pem
LOCALHOST_HTTPS_CERT=/Users/yourusername/certs/localhost.pem
```

**Important:**

- Use absolute paths
- Replace `yourusername` with your actual username

Once configured, Nuxt will automatically detect the environment variables and enable HTTPS. The Nuxt configuration in `nuxt.config.ts` automatically enables HTTPS when both `LOCALHOST_HTTPS_KEY` and `LOCALHOST_HTTPS_CERT` environment variables are set:

```typescript
...(process.env.LOCALHOST_HTTPS_KEY && process.env.LOCALHOST_HTTPS_CERT ? {
  devServer: {
    https: {
      key: process.env.LOCALHOST_HTTPS_KEY,
      cert: process.env.LOCALHOST_HTTPS_CERT
    }
  }
} : {}),
```

The server will then start on `https://localhost:3000` instead of `http://localhost:3000`.

#### 6. Update URL in OAuth apps

When you enable HTTPS for local development, you must update the callback or redirect URLs in your OAuth app settings (on Google and optionally GitHub) to use `https://` instead of `http://`. This ensures the OAuth provider will redirect you back to your local secure server successfully.

Google supports multiple URLs, so the same OAuth app can support both protocols. But for GitHub, you will loose the option to use it in HTTP mode or will need to define a separate app with distinct `NUXT_OAUTH_GITHUB_CLIENT_ID` and `NUXT_OAUTH_GITHUB_CLIENT_SECRET` values.

For more information on configuring OAuth apps for development, see:

- [GitHub OAuth app setup](./auth.md#creating-and-configuring-githubs-oauth-app)
- [Google OAuth app setup](./auth.md#creating-and-configuring-googles-oauth-app)

#### 7. Start the development mode with `pnpm dev-https` instead of `dev`

Use the dedicated `dev-https` script which also sets up Node.js to trust the mkcert CA:

```bash
pnpm dev-https
```

instead of `pnpm dev`.

This script:

- Exports `NODE_EXTRA_CA_CERTS` to point to mkcert's root CA
- Ensures Node.js trusts certificates signed by mkcert
- Starts the development server with HTTPS enabled

#### Additional notes

- The certificates are valid for localhost and 127.0.0.1 only
- These certificates should **never** be committed to version control
- If you need certificates for other domains or IPs, add them to the `mkcert` command: `mkcert localhost 127.0.0.1 example.local`
- To revoke trust, run `mkcert -uninstall` (this removes the CA from your system's trust store)

### Troubleshooting

#### Browser Shows Security Warning

If your browser still shows a security warning:

- Ensure `mkcert -install` was run successfully
- Try restarting your browser
- Check that the certificate files exist at the specified paths

#### Certificate Not Found Error

If you see errors about missing certificate files:

- Verify the paths in your `.env` file are absolute and correct
- Check that the certificate files exist at those paths
- Ensure you have read permissions on the certificate files

#### Node.js Doesn't Trust the Certificate

If Node.js (used by the server) doesn't trust the certificate: `unable to verify the first certificate; if the root CA is installed locally, try running Node.js with --use-system-ca`:

- Use the `pnpm dev-https` script which sets `NODE_EXTRA_CA_CERTS`
- Or manually export the variable: `export NODE_EXTRA_CA_CERTS="$(mkcert -CAROOT)/rootCA.pem"`

## Configure local CouchDB for HTTPS

[To enable HTTPS in CouchDB, you need to configure SSL/TLS certificates and CORS settings](http://127.0.0.1:5984/_utils/docs/config/http.html#https-tls-options). This section explains how to configure CouchDB to work with your HTTPS-enabled Nuxt development server.

### View Configuration

You can view the current CouchDB configuration using curl:

```bash
curl http://localhost:5984/_node/_local/_config
```

To view a specific configuration section:

```bash
curl http://localhost:5984/_node/_local/_config/cors
```

### Set Configuration Values at Runtime for transient testing

You can set configuration values at runtime using curl:

```bash
curl -X PUT http://localhost:5984/_node/_local/_config/cors/enable_cors \
     -d '"true"'
```

⚠️ **Important:** Runtime changes do not persist across restarts unless written to disk. For permanent configuration, you should edit the CouchDB configuration file directly.

### Required Configuration

Add the following configuration sections to your CouchDB configuration file. The location of this file depends on your installation:

- **macOS (Homebrew):** `/opt/homebrew/etc/couchdb/local.ini` or `/usr/local/etc/couchdb/local.ini`
- **macOS (App):** `~/Library/Application Support/CouchDB/etc/couchdb/local.ini`
- **Linux:** `/etc/couchdb/local.ini`

#### CORS Configuration

```ini
[cors]
credentials = true
enable_cors = true
headers=accept, authorization, content-type, origin, referer, user-agent, x-ibmcloud-sdk-analytics, content-encoding
origins = https://localhost:3000
```

The extra headers `user-agent`, `x-ibmcloud-sdk-analytics`, `content-encoding` [are required by IBMs Cloudant SDK which Firn uses](https://github.com/IBM/cloudant-node-sdk?tab=readme-ov-file#cors).

#### SSL Configuration

```ini
[ssl]
enable = true
cert_file = /path/to/localhost.pem
key_file = /path/to/localhost-key.pem
```

**Note:** Use the same certificate files generated for Nuxt (see [HTTPS Certificate setup steps](#https-certificate-setup-steps)). Update the paths to match your certificate location (e.g., `/Users/yourusername/certs/localhost.pem`).

#### HTTP Configuration

```ini
[httpd]
port = 5984
bind_address = 127.0.0.1
```

#### HTTPS Configuration

```ini
[httpsd]
port = 6984
bind_address = 127.0.0.1
```

### Restart CouchDB

After making configuration changes, restart CouchDB to apply them.

#### For macOS App

```bash
osascript -e 'quit app "Apache CouchDB"'
open -a "Apache CouchDB"
```

#### For Homebrew Installation

```bash
brew services restart couchdb
```

#### For Systemd (Linux)

```bash
sudo systemctl restart couchdb
```

### Verify HTTPS Works

Test that CouchDB is responding over HTTPS:

```bash
curl https://localhost:6984
```

You should see a JSON response indicating CouchDB is running. If you see certificate warnings, you may need to use the `-k` flag for testing:

```bash
curl -k https://localhost:6984
```

Check listening ports, if no output is shown, CouchDB is not bound to HTTPS yet.

```bash
lsof -iTCP -sTCP:LISTEN -n -P | grep 6984
```

### Update Your Nuxt App to Use HTTPS CouchDB

Update your `.env` file to use the HTTPS endpoint of CouchDB:

```bash
COUCHDB_URL=https://localhost:6984
```

Make sure to use the HTTPS port (`6984`) instead of the HTTP port (`5984`).
